name: Tag è‡ªåŠ¨éƒ¨ç½² & ç‰ˆæœ¬å›æ»šï¼ˆCDï¼‰

# è§¦å‘è§„åˆ™ï¼š1. æ¨é€v*æ ¼å¼Tagè‡ªåŠ¨éƒ¨ç½²ï¼›2. æ‰‹åŠ¨è§¦å‘å›æ»š
on:
  push:
    tags:
      - 'v*' # åŒ¹é… v1.0ã€v2.1.0 ç­‰ Tag æ ¼å¼
  workflow_dispatch:
    inputs:
      rollback_tag:
        description: 'è¦å›æ»šçš„ Tag åç§°ï¼ˆå¦‚ v1.0ï¼‰'
        required: false
        type: string
      action_type:
        description: 'æ“ä½œç±»å‹ï¼šdeployï¼ˆéƒ¨ç½²ï¼‰/rollbackï¼ˆå›æ»šï¼‰'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - rollback

jobs:
  # è‡ªåŠ¨éƒ¨ç½²ä»»åŠ¡ï¼ˆTagæ¨é€è§¦å‘ï¼‰
  deploy:
    runs-on: ubuntu-latest
    # ä»…åœ¨Tagæ¨é€/æ‰‹åŠ¨é€‰æ‹©deployæ—¶æ‰§è¡Œ
    if: github.event.inputs.action_type == 'deploy' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    steps:
      - name: æ‹‰å–ä»“åº“æŒ‡å®š Tag ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }} # æ‹‰å–è§¦å‘éƒ¨ç½²çš„ Tag ä»£ç 
          fetch-depth: 0 # æ‹‰å–æ‰€æœ‰å†å²ï¼Œç¡®ä¿Tagå®Œæ•´

      - name: é…ç½® SSH å…å¯†è¿æ¥æœºå™¨ B
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: éƒ¨ç½²å‰å¤‡ä»½æœºå™¨ B å½“å‰ç‰ˆæœ¬
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
          BACKUP_DIR: ${{ secrets.BACKUP_DIR }}
          TAG_NAME: ${{ github.ref_name }} # å½“å‰ Tag åç§°ï¼ˆå¦‚ v1.0ï¼‰
        run: |
          # 1. è¿æ¥æœºå™¨ Bï¼Œåˆ›å»ºå¤‡ä»½/éƒ¨ç½²ç›®å½•ï¼ˆç¡®ä¿å­˜åœ¨ï¼‰
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "mkdir -p $BACKUP_DIR $DEPLOY_DIR"
          # 2. ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½ç›®å½•åï¼ˆé¿å…é‡å¤ï¼‰
          BACKUP_NAME=$(date +%Y%m%d_%H%M%S)_$TAG_NAME
          # 3. å¤‡ä»½å½“å‰éƒ¨ç½²ç›®å½•ï¼ˆå…ˆæ£€æŸ¥éƒ¨ç½²ç›®å½•æ˜¯å¦æœ‰å†…å®¹ï¼Œé¿å…ç©ºå¤‡ä»½ï¼‰
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            if [ -d $DEPLOY_DIR ] && [ $(ls -A $DEPLOY_DIR | wc -l) -gt 0 ]; then
              cp -r $DEPLOY_DIR $BACKUP_DIR/$BACKUP_NAME &&
              echo 'âœ… å¤‡ä»½æˆåŠŸï¼š$BACKUP_DIR/$BACKUP_NAME'
            else
              echo 'âš ï¸ éƒ¨ç½²ç›®å½•ä¸ºç©ºï¼Œè·³è¿‡å¤‡ä»½'
            fi
          "
          echo "ğŸ“ å¤‡ä»½è®°å½•ï¼š$BACKUP_DIR/$BACKUP_NAME"

      - name: å°† Tag ä»£ç ä¼ è¾“åˆ°æœºå™¨ B éƒ¨ç½²ç›®å½•
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          # ç”¨rsyncä¼ è¾“ä»£ç ï¼ˆæ’é™¤æŒ‡å®šæ–‡ä»¶ï¼Œè¦†ç›–éƒ¨ç½²ç›®å½•ï¼‰
          rsync -avz \
            --exclude=".git" \
            --exclude=".github" \
            --exclude="node_modules" \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ $SSH_USER@$SSH_HOST:$DEPLOY_DIR/
          echo "âœ… Tag ä»£ç å·²æˆåŠŸä¼ è¾“åˆ°æœºå™¨ Bï¼š$DEPLOY_DIR"

      - name: å¯é€‰ï¼šæ‰§è¡Œæœºå™¨ B éƒ¨ç½²åè„šæœ¬ï¼ˆå¦‚å¯åŠ¨æœåŠ¡ï¼‰
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          # ç¤ºä¾‹ï¼šè¿›å…¥éƒ¨ç½²ç›®å½•ï¼Œå®‰è£…ä¾èµ–ã€é‡å¯æœåŠ¡ï¼ˆæ ¹æ®ä½ çš„ä¸šåŠ¡ä¿®æ”¹ï¼‰
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            cd $DEPLOY_DIR &&
            # pip install -r requirements.txt || true &&
            # systemctl restart your_service || true
            echo 'éƒ¨ç½²åè„šæœ¬æ‰§è¡Œå®Œæˆ'
          "

  # å›æ»šä»»åŠ¡ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰
  rollback:
    runs-on: ubuntu-latest
    # ä»…åœ¨æ‰‹åŠ¨é€‰æ‹©rollbackä¸”æŒ‡å®šäº†å›æ»šTagæ—¶æ‰§è¡Œ
    if: github.event.inputs.action_type == 'rollback' && github.event.inputs.rollback_tag != ''
    steps:
      - name: é…ç½® SSH å…å¯†è¿æ¥æœºå™¨ B
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: å›æ»šåˆ°æŒ‡å®š Tag ç‰ˆæœ¬ï¼ˆå¢å¼ºç‰ˆï¼‰
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
          BACKUP_DIR: ${{ secrets.BACKUP_DIR }}
          ROLLBACK_TAG: ${{ github.event.inputs.rollback_tag }}
        run: |
          # æ­¥éª¤1ï¼šå…ˆæ£€æŸ¥å¤‡ä»½æ ¹ç›®å½•æ˜¯å¦å­˜åœ¨
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            if [ ! -d $BACKUP_DIR ]; then
              echo 'âŒ å¤‡ä»½æ ¹ç›®å½•ä¸å­˜åœ¨ï¼š$BACKUP_DIR'
              exit 1
            fi
          "

          # æ­¥éª¤2ï¼šæŸ¥æ‰¾è¯¥ Tag å¯¹åº”çš„æœ€æ–°å¤‡ä»½ï¼ˆç²¾å‡†åŒ¹é…ï¼Œé¿å…æ‚é¡¹å¹²æ‰°ï¼‰
          BACKUP_PATH=$(ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            ls $BACKUP_DIR | grep -E '_$ROLLBACK_TAG$' | sort -r | head -1
          ")

          if [ -n "$BACKUP_PATH" ]; then
            # æ–¹å¼1ï¼šä»å¤‡ä»½æ¢å¤ï¼ˆå…ˆæ£€æŸ¥å¤‡ä»½ç›®å½•æ˜¯å¦æœ‰å†…å®¹ï¼‰
            echo "ğŸ” æ‰¾åˆ°æœ€æ–°å¤‡ä»½ï¼š$BACKUP_DIR/$BACKUP_PATH"
            ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
              # æ£€æŸ¥å¤‡ä»½ç›®å½•æ˜¯å¦æœ‰å†…å®¹
              if [ $(ls -A $BACKUP_DIR/$BACKUP_PATH | wc -l) -eq 0 ]; then
                echo 'âŒ å¤‡ä»½ç›®å½•ä¸ºç©ºï¼Œæ— æ³•æ¢å¤'
                exit 1
              fi
              # æ¸…ç©ºéƒ¨ç½²ç›®å½•ï¼ˆé¿å…æ®‹ç•™æ–‡ä»¶ï¼‰
              rm -rf $DEPLOY_DIR/*
              # å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ°éƒ¨ç½²ç›®å½•
              cp -r $BACKUP_DIR/$BACKUP_PATH/* $DEPLOY_DIR/ &&
              echo 'âœ… ä»å¤‡ä»½æ¢å¤æˆåŠŸï¼š$ROLLBACK_TAG'
            "
          else
            # æ–¹å¼2ï¼šæ— å¤‡ä»½æ—¶ï¼Œæ‹‰å–ä»“åº“æŒ‡å®š Tag ä»£ç ï¼ˆå¢å¼ºå®¹é”™ï¼‰
            echo "âš ï¸ æœªæ‰¾åˆ° $ROLLBACK_TAG å¤‡ä»½ï¼Œå°è¯•ç›´æ¥ä»ä»“åº“æ‹‰å–"
            ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
              # æ£€æŸ¥æœºå™¨Bæ˜¯å¦å®‰è£…git
              if ! command -v git &> /dev/null; then
                echo 'âŒ æœºå™¨Bæœªå®‰è£…gitï¼Œæ— æ³•æ‹‰å–ä»£ç '
                exit 1
              fi
              # è¿›å…¥éƒ¨ç½²ç›®å½•ï¼Œåˆå§‹åŒ–gitï¼ˆè‹¥æœªåˆå§‹åŒ–ï¼‰
              cd $DEPLOY_DIR &&
              if [ ! -d .git ]; then
                git init &&
                git remote add origin https://github.com/napoleon516/script.git
              fi
              # æ‹‰å–æŒ‡å®šTagä»£ç 
              git fetch origin tag $ROLLBACK_TAG &&
              git reset --hard $ROLLBACK_TAG &&
              echo 'âœ… ç›´æ¥æ‹‰å– Tag ä»£ç å›æ»šæˆåŠŸï¼š$ROLLBACK_TAG'
            "
          fi

      - name: å¯é€‰ï¼šå›æ»šåé‡å¯æœåŠ¡
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          DEPLOY_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "
            cd $DEPLOY_DIR &&
            # systemctl restart your_service || true
            echo 'å›æ»šåæœåŠ¡é‡å¯å®Œæˆ'
          "
